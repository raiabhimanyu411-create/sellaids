{"version":3,"file":"static/js/9201.798f1292.chunk.js","mappings":"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","sources":["pages/dashboard/Payments.js"],"sourcesContent":["import React, { useEffect, useState } from \"react\";\nimport { useLocation, useNavigate } from \"react-router-dom\";\nimport { useUserStore } from \"../../stores/useUserStore\";\nimport useCartStore from \"../../stores/useCartStore\";\nimport axios from \"axios\";\nimport { toast, Toaster } from \"react-hot-toast\";\n\nconst CHECKOUT_STORAGE_KEY = \"checkout_order_data\";\n\nexport default function Payments({\n  orderData: propOrderData,   // <-- new prop\n  onSuccess,\n  isCheckoutFlow = false,\n}) {\n  const { user, isAuthenticated, fetchUser } = useUserStore();\n  const { clearCart } = useCartStore();\n  const location = useLocation();\n  const navigate = useNavigate();\n\n  const [orderData, setOrderData] = useState(propOrderData);\n  const [loading, setLoading] = useState(true);\n\n  /* ------------------------------------------------------------------ */\n  /* 1. Prefer prop (checkout flow) → fallback to session → API fetch   */\n  /* ------------------------------------------------------------------ */\n  useEffect(() => {\n    const init = async () => {\n      // 1. Checkout flow – we already have the data\n      if (isCheckoutFlow && propOrderData) {\n        setOrderData(propOrderData);\n        setLoading(false);\n        return;\n      }\n\n      // 2. Try session storage (different key for checkout)\n      const saved = sessionStorage.getItem(CHECKOUT_STORAGE_KEY);\n      if (saved) {\n        setOrderData(JSON.parse(saved));\n        setLoading(false);\n        return;\n      }\n\n      // 3. Dashboard flow – fetch latest pending order\n      if (user?.id) {\n        await fetchLatestOrder();\n      }\n      setLoading(false);\n    };\n\n    init();\n  }, [propOrderData, isCheckoutFlow, user?.id]);\n\n  const fetchLatestOrder = async () => {\n    try {\n      const res = await axios.get(\n        `${import.meta.env.VITE_API_URL}/api/payment/user/${user.id}/latest-order`,\n        { withCredentials: true }\n      );\n      setOrderData(res.data.data);\n    } catch (err) {\n      console.error(\"Failed to fetch latest order:\", err);\n      toast.error(\"Could not load order. Redirecting...\");\n      setTimeout(() => navigate(\"/user\"), 1500);\n    }\n  };\n\n  /* ------------------------------------------------------------------ */\n  /* 2. Load Razorpay script (only once)                               */\n  /* ------------------------------------------------------------------ */\n  const loadRazorpay = async () => {\n    if (window.Razorpay) {\n      openPayment();\n      return;\n    }\n\n    const script = document.createElement(\"script\");\n    script.src = \"https://checkout.razorpay.com/v1/checkout.js\";\n    script.async = true;\n    document.body.appendChild(script);\n\n    script.onload = () => openPayment();\n    script.onerror = () => {\n      toast.error(\"Failed to load Razorpay\");\n      setTimeout(() => navigate(\"/user\"), 1500);\n    };\n  };\n\n  /* ------------------------------------------------------------------ */\n  /* 3. Open Razorpay modal                                             */\n  /* ------------------------------------------------------------------ */\n  const openPayment = () => {\n    if (!window.Razorpay) return;\n\n    const options = {\n      key: orderData.key,\n      order_id: orderData.razorpayOrderId,\n      amount: orderData.amount,\n      currency: orderData.currency,\n      name: \"Sellaids\",\n      description: \"Payment for your order\",\n      handler: async (response) => {\n        try {\n          const verifyRes = await axios.post(\n            `${import.meta.env.VITE_API_URL}/api/payment/verify`,\n            {\n              razorpay_order_id: response.razorpay_order_id,\n              razorpay_payment_id: response.razorpay_payment_id,\n              razorpay_signature: response.razorpay_signature,\n              orderIds: orderData.orderIds,\n            },\n            { withCredentials: true }\n          );\n\n          if (verifyRes.data.success) {\n            toast.success(\"Payment Successful!\");\n            await clearCart();\n            sessionStorage.removeItem(CHECKOUT_STORAGE_KEY);\n            if (onSuccess) onSuccess();\n            setTimeout(() => navigate(\"/user\"), 1500);\n          } else {\n            toast.error(\"Payment verification failed!\");\n          }\n        } catch (err) {\n          toast.error(\"Payment verification failed!\");\n        }\n      },\n      modal: {\n        ondismiss: async () => {\n          toast.loading(\"Cancelling payment...\");\n          try {\n            await axios.post(\n              `${import.meta.env.VITE_API_URL}/api/payment/cancel`,\n              {\n                razorpayOrderId: orderData.razorpayOrderId,\n                orderIds: orderData.orderIds,\n              },\n              { withCredentials: true }\n            );\n            toast.dismiss();\n            toast.error(\"Payment cancelled\");\n            sessionStorage.removeItem(CHECKOUT_STORAGE_KEY);\n            setTimeout(() => navigate(\"/user\"), 1000);\n          } catch (err) {\n            toast.dismiss();\n            toast.error(\"Failed to cancel payment\");\n          }\n        },\n      },\n      prefill: {\n        name: user?.name || \"\",\n        email: user?.email || \"\",\n        contact: user?.mobile || \"\",\n      },\n      theme: { color: \"#2563eb\" },\n    };\n\n    const rzp = new window.Razorpay(options);\n    rzp.open();\n  };\n\n  /* ------------------------------------------------------------------ */\n  /* 4. Validation – show error UI                                      */\n  /* ------------------------------------------------------------------ */\n  const isValid =\n    orderData?.key &&\n    orderData?.razorpayOrderId &&\n    orderData?.amount &&\n    orderData?.currency &&\n    Array.isArray(orderData?.orderIds) &&\n    orderData.orderIds.length > 0;\n\n  useEffect(() => {\n    if (!loading && isValid) {\n      loadRazorpay();\n    }\n  }, [loading, isValid]);\n\n  /* ------------------------------------------------------------------ */\n  /* 5. Render                                                          */\n  /* ------------------------------------------------------------------ */\n  if (loading) {\n    return (\n      <div className=\"flex justify-center items-center h-screen\">\n        <Toaster />\n        <p className=\"text-gray-600 text-lg\">Loading payment gateway...</p>\n      </div>\n    );\n  }\n\n  if (!isValid) {\n    return (\n      <div className=\"flex justify-center items-center h-screen\">\n        <Toaster />\n        <p className=\"text-red-600 text-lg\">\n          Invalid order data. Redirecting to dashboard...\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex justify-center items-center h-screen bg-gray-50\">\n      <Toaster />\n      <div className=\"bg-white p-8 rounded-xl shadow-md text-center max-w-md\">\n        <h1 className=\"text-2xl font-bold mb-4 text-gray-800\">\n          Redirecting to Razorpay...\n        </h1>\n        <p className=\"text-gray-600 mb-4\">\n          Please wait while we open the secure payment window.\n        </p>\n        <div className=\"animate-pulse text-blue-600 font-medium\">\n          Initializing Payment...\n        </div>\n      </div>\n    </div>\n  );\n}"],"names":["CHECKOUT_STORAGE_KEY","Payments","_ref","orderData","propOrderData","onSuccess","isCheckoutFlow","user","isAuthenticated","fetchUser","useUserStore","clearCart","useCartStore","navigate","useLocation","useNavigate","setOrderData","useState","loading","setLoading","useEffect","async","saved","sessionStorage","getItem","JSON","parse","id","fetchLatestOrder","init","res","axios","get","concat","process","withCredentials","data","err","console","error","toast","setTimeout","openPayment","window","Razorpay","options","key","order_id","razorpayOrderId","amount","currency","name","description","handler","post","razorpay_order_id","response","razorpay_payment_id","razorpay_signature","orderIds","success","removeItem","modal","ondismiss","dismiss","prefill","email","contact","mobile","theme","color","open","isValid","Array","isArray","length","script","document","createElement","src","body","appendChild","onload","onerror","loadRazorpay","_jsxs","className","children","_jsx","Toaster"],"ignoreList":[],"sourceRoot":""}